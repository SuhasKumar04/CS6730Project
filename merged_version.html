<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Music trend (Genre multi‑select)</title>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<style>
  :root { --ink: #e8edf7; }
  body { margin:0; background:#0f1b33; color:var(--ink); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }

  /* Boombox stage (1488×846) */
  .boombox {
    position: relative;
    width: min(95vw, calc(95vh * (1488 / 846)));
    aspect-ratio: 1488 / 846;
    margin: 24px auto;
    background: url("./boombox.png") center / contain no-repeat;
    border-radius: 12px;
    box-shadow: 0 12px 40px rgba(0,0,0,.35);
  }

  .region { position: absolute; overflow: hidden; display: grid; place-items: center; pointer-events: auto; }

  /* Center screen */
  #center-rect { left: 25%; top: 23%; width: 50%; height: 60%; background: rgba(51, 67, 109, 0.25); box-shadow: inset 0 0 0 1px rgba(255,255,255,.04); border-radius: 6px; }
  #center-rect svg { width: 100%; height: 100%; display: block; }

  /* Speaker circles */
  #left-circle, #right-circle { width: 20%; aspect-ratio: 1 / 1; border-radius: 50%; background: rgba(16,26,52,.22); box-shadow: inset 0 0 0 1px rgba(255,255,255,.06); }
  #left-circle  { left: 2%;  top: 49.5%; transform: translateY(-50%); }
  #right-circle { right: 2%; top: 49.5%; transform: translateY(-50%); }

  .circle-card { width: 82%; height: 82%; background: rgba(7,12,28,.7); border: 1px solid rgba(255,255,255,.06); border-radius: 50%; display: grid; place-items: center; padding: 10px; text-align: center; }

  /* Left: view buttons */
  .legend { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 6px 8px; align-items: start; width: 100%; padding-left: 20px; }
  .legend > strong { grid-column: 1 / -1; margin-bottom: 6px; display: block; font-size: 13px; text-align: center; }
  .legend button { width: 80%; margin: 0; padding: 6px 8px; border-radius: 8px; background:#22315f; color:#e8edf7; border:1px solid #33457a; cursor:pointer; font-size: 11px; text-align: center; }
  .legend button.active { outline: 2px solid #a78bfa; }

  #rightContent { width: 88%; color:#e8edf7; }
  #rightContent h4 { margin: 4px 0 8px; font-size: 14px; }
  .ctl-row { display:flex; align-items:center; justify-content:center; gap:6px; margin: 6px 0 10px; flex-wrap:wrap; }
  .pill { font-size: 11px; padding:4px 8px; border-radius: 999px; border:1px solid rgba(255,255,255,.18); background:#21325f; cursor:pointer; }
  .pill:hover { background:#2a3a6d; }
  .tiny { font-size: 11px; opacity: .85; }
  .genre-grid { display:grid; grid-template-columns: 1fr 1fr; gap: 6px 10px; max-height: 58%; overflow:auto; padding-right:4px; }
  .genre-item { display:flex; align-items:center; gap:6px; }
  .swatch { width: 10px; height:10px; border-radius:2px; display:inline-block; }
  .empty-note { font-size: 12px; opacity:.9; text-align:center; margin-top: 8px; }

  /* Tooltip for charts */
  .tooltip { position: absolute; background: rgba(7,12,28,0.95); color: #e8edf7; border: 1px solid rgba(255,255,255,0.1); padding: 6px 8px; font-size: 13px; pointer-events: none; opacity: 0; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
</style>

<style>
/* === Circle visibility and spacing fixes === */
#left-circle, #right-circle { width: 24% !important; }            /* make circles bigger */
.circle-card{
  width: 90% !important;
  height: 90% !important;
  padding: 8px !important;
}
#rightContent{ font-size: 13px !important; }
#rightContent h4{ font-size: 16px !important; margin: 4px 0 8px !important; }
.ctl-row{ gap: 6px !important; margin: 6px 0 8px !important; }
.pill{ font-size: 10px !important; padding: 4px 8px !important; }
.genre-grid{ gap: 4px 8px !important; max-height: 64% !important; } /* more room to breathe */
</style>

</head>
<body>

<div class="boombox">
  <!-- center: main plot -->
  <div id="center-rect" class="region">
    <svg id="mainChart" viewBox="0 0 900 560" preserveAspectRatio="xMidYMid meet"></svg>
  </div>

  <!-- left: all views listed as buttons -->
  <div id="left-circle" class="region">
    <div class="circle-card">
      <div class="legend">
        <strong style="margin-bottom:6px;display:block;margin-left:-20px;">Select View</strong>
        <button data-view="genre" class="active">Genre</button>
        <button data-view="tempo">Tempo</button>
        <button data-view="danceability">Danceability</button>
        <button data-view="energy">Energy</button>
        <button data-view="acousticness">Acousticness</button>
        <button data-view="duration_ms">Duration</button>
      </div>
    </div>
  </div>

  <!-- right: dynamic controls -->
  <div id="right-circle" class="region">
    <div class="circle-card">
      <div id="rightContent"></div>
    </div>
  </div>
</div>

<!-- tooltip -->
<div class="tooltip" id="tooltip"></div>

<script>
// ------------------ DATA ------------------
const audioData = [
  {year:1980,danceability:0.620,energy:0.571,tempo:103.130,acousticness:0.356,duration_ms:207390},
  {year:1981,danceability:0.630,energy:0.649,tempo:123.569,acousticness:0.304,duration_ms:227191},
  {year:1982,danceability:0.668,energy:0.629,tempo:120.588,acousticness:0.141,duration_ms:235502},
  {year:1983,danceability:0.697,energy:0.593,tempo:122.858,acousticness:0.139,duration_ms:252009},
  {year:1984,danceability:0.651,energy:0.691,tempo:116.194,acousticness:0.176,duration_ms:249788},
  {year:1985,danceability:0.663,energy:0.656,tempo:107.884,acousticness:0.173,duration_ms:279528},
  {year:1986,danceability:0.625,energy:0.570,tempo:112.360,acousticness:0.209,duration_ms:272095},
  {year:1987,danceability:0.625,energy:0.792,tempo:108.949,acousticness:0.226,duration_ms:263893},
  {year:1988,danceability:0.622,energy:0.705,tempo:121.720,acousticness:0.227,duration_ms:260760},
  {year:1989,danceability:0.679,energy:0.668,tempo:110.760,acousticness:0.271,duration_ms:253647},
  {year:1990,danceability:0.649,energy:0.606,tempo:115.785,acousticness:0.286,duration_ms:277173},
  {year:1991,danceability:0.621,energy:0.555,tempo:115.620,acousticness:0.196,duration_ms:273140},
  {year:1992,danceability:0.707,energy:0.568,tempo:113.428,acousticness:0.175,duration_ms:270712},
  {year:1993,danceability:0.706,energy:0.566,tempo:109.532,acousticness:0.253,duration_ms:269637},
  {year:1994,danceability:0.640,energy:0.562,tempo:113.855,acousticness:0.249,duration_ms:243978},
  {year:1995,danceability:0.687,energy:0.570,tempo:120.888,acousticness:0.230,duration_ms:270767},
  {year:1996,danceability:0.643,energy:0.479,tempo:129.628,acousticness:0.432,duration_ms:262663},
  {year:1997,danceability:0.706,energy:0.622,tempo:105.768,acousticness:0.167,duration_ms:258585},
  {year:1998,danceability:0.641,energy:0.499,tempo:131.300,acousticness:0.214,duration_ms:273190},
  {year:1999,danceability:0.654,energy:0.655,tempo:123.767,acousticness:0.181,duration_ms:231018},
  {year:2000,danceability:0.645,energy:0.649,tempo:112.342,acousticness:0.159,duration_ms:260767},
  {year:2001,danceability:0.632,energy:0.693,tempo:99.549,acousticness:0.172,duration_ms:232442},
  {year:2002,danceability:0.655,energy:0.731,tempo:122.503,acousticness:0.120,duration_ms:245053},
  {year:2003,danceability:0.651,energy:0.759,tempo:95.572,acousticness:0.142,duration_ms:226088},
  {year:2004,danceability:0.738,energy:0.684,tempo:103.611,acousticness:0.158,duration_ms:230300},
  {year:2005,danceability:0.713,energy:0.650,tempo:121.201,acousticness:0.142,duration_ms:220696},
  {year:2006,danceability:0.778,energy:0.698,tempo:123.144,acousticness:0.191,duration_ms:232418},
  {year:2007,danceability:0.631,energy:0.679,tempo:138.635,acousticness:0.238,duration_ms:237920},
  {year:2008,danceability:0.690,energy:0.561,tempo:112.681,acousticness:0.309,duration_ms:231876},
  {year:2009,danceability:0.713,energy:0.693,tempo:128.154,acousticness:0.128,duration_ms:224747},
  {year:2010,danceability:0.707,energy:0.826,tempo:109.248,acousticness:0.121,duration_ms:238075},
  {year:2011,danceability:0.689,energy:0.771,tempo:121.964,acousticness:0.124,duration_ms:224520},
  {year:2012,danceability:0.682,energy:0.707,tempo:128.416,acousticness:0.094,duration_ms:217835},
  {year:2013,danceability:0.597,energy:0.684,tempo:123.647,acousticness:0.187,duration_ms:253207},
  {year:2014,danceability:0.630,energy:0.656,tempo:124.885,acousticness:0.240,duration_ms:219400},
  {year:2015,danceability:0.723,energy:0.669,tempo:111.208,acousticness:0.161,duration_ms:227923},
  {year:2016,danceability:0.654,energy:0.632,tempo:130.298,acousticness:0.187,duration_ms:227330},
  {year:2017,danceability:0.769,energy:0.666,tempo:126.141,acousticness:0.184,duration_ms:225174},
  {year:2018,danceability:0.709,energy:0.664,tempo:120.574,acousticness:0.084,duration_ms:216595},
  {year:2019,danceability:0.778,energy:0.576,tempo:127.334,acousticness:0.217,duration_ms:209586},
  {year:2020,danceability:0.705,energy:0.626,tempo:116.776,acousticness:0.253,duration_ms:200920}
];

const genreMini = [
  { year: "1980", "Country Pop": 0,  "Hip Hop": 0, "Latin Pop": 0, Pop: 1, "Pop Ballad": 1, "Pop Rap": 0, "Pop Rock": 3, "R&B": 1, Rap: 0, Rock: 4 },
  { year: "1981", "Country Pop": 2,  "Hip Hop": 0, "Latin Pop": 0, Pop: 0, "Pop Ballad": 1, "Pop Rap": 0, "Pop Rock": 6, "R&B": 1, Rap: 0, Rock: 0 },
  { year: "1982", "Country Pop": 0,  "Hip Hop": 0, "Latin Pop": 0, Pop: 2, "Pop Ballad": 0, "Pop Rap": 0, "Pop Rock": 5, "R&B": 1, Rap: 0, Rock: 2 },
  { year: "1983", "Country Pop": 0,  "Hip Hop": 0, "Latin Pop": 0, Pop: 4, "Pop Ballad": 1, "Pop Rap": 0, "Pop Rock": 4, "R&B": 0, Rap: 0, Rock: 1 },
  { year: "1984", "Country Pop": 0,  "Hip Hop": 0, "Latin Pop": 0, Pop: 3, "Pop Ballad": 0, "Pop Rap": 0, "Pop Rock": 2, "R&B": 3, Rap: 0, Rock: 2 },
  { year: "1985", "Country Pop": 0,  "Hip Hop": 0, "Latin Pop": 0, Pop: 3, "Pop Ballad": 1, "Pop Rap": 0, "Pop Rock": 3, "R&B": 2, Rap: 0, Rock: 1 },
  { year: "1986", "Country Pop": 0,  "Hip Hop": 0, "Latin Pop": 0, Pop: 3, "Pop Ballad": 1, "Pop Rap": 0, "Pop Rock": 3, "R&B": 2, Rap: 0, Rock: 1 },
  { year: "1987", "Country Pop": 0,  "Hip Hop": 0, "Latin Pop": 0, Pop: 3, "Pop Ballad": 0, "Pop Rap": 0, "Pop Rock": 4, "R&B": 0, Rap: 0, Rock: 3 },
  { year: "1988", "Country Pop": 0,  "Hip Hop": 0, "Latin Pop": 0, Pop: 4, "Pop Ballad": 1, "Pop Rap": 0, "Pop Rock": 3, "R&B": 0, Rap: 0, Rock: 2 },
  { year: "1989", "Country Pop": 0,  "Hip Hop": 0, "Latin Pop": 0, Pop: 5, "Pop Ballad": 1, "Pop Rap": 0, "Pop Rock": 2, "R&B": 1, Rap: 0, Rock: 1 },
  { year: "1990", "Country Pop": 0,  "Hip Hop": 0, "Latin Pop": 0, Pop: 2, "Pop Ballad": 2, "Pop Rap": 0, "Pop Rock": 2, "R&B": 2, Rap: 0, Rock: 2 },
  { year: "1991", "Country Pop": 0,  "Hip Hop": 0, "Latin Pop": 0, Pop: 4, "Pop Ballad": 2, "Pop Rap": 0, "Pop Rock": 1, "R&B": 2, Rap: 0, Rock: 1 },
  { year: "1992", "Country Pop": 0,  "Hip Hop": 2, "Latin Pop": 0, Pop: 1, "Pop Ballad": 2, "Pop Rap": 0, "Pop Rock": 0, "R&B": 4, Rap: 0, Rock: 1 },
  { year: "1993", "Country Pop": 0,  "Hip Hop": 2, "Latin Pop": 0, Pop: 2, "Pop Ballad": 1, "Pop Rap": 0, "Pop Rock": 0, "R&B": 5, Rap: 0, Rock: 0 },
  { year: "1994", "Country Pop": 0,  "Hip Hop": 0, "Latin Pop": 0, Pop: 3, "Pop Ballad": 3, "Pop Rap": 0, "Pop Rock": 2, "R&B": 2, Rap: 0, Rock: 0 },
  { year: "1995", "Country Pop": 0,  "Hip Hop": 1, "Latin Pop": 0, Pop: 5, "Pop Ballad": 0, "Pop Rap": 0, "Pop Rock": 0, "R&B": 4, Rap: 0, Rock: 0 },
  { year: "1996", "Country Pop": 0,  "Hip Hop": 1, "Latin Pop": 1, Pop: 3, "Pop Ballad": 1, "Pop Rap": 0, "Pop Rock": 1, "R&B": 3, Rap: 0, Rock: 0 },
  { year: "1997", "Country Pop": 1,  "Hip Hop": 2, "Latin Pop": 0, Pop: 2, "Pop Ballad": 4, "Pop Rap": 0, "Pop Rock": 0, "R&B": 1, Rap: 0, Rock: 0 },
  { year: "1998", "Country Pop": 2,  "Hip Hop": 0, "Latin Pop": 0, Pop: 2, "Pop Ballad": 2, "Pop Rap": 0, "Pop Rock": 1, "R&B": 3, Rap: 0, Rock: 0 },
  { year: "1999", "Country Pop": 0,  "Hip Hop": 0, "Latin Pop": 1, Pop: 5, "Pop Ballad": 3, "Pop Rap": 0, "Pop Rock": 1, "R&B": 0, Rap: 0, Rock: 0 },
  { year: "2000", "Country Pop": 2,  "Hip Hop": 0, "Latin Pop": 2, Pop: 2, "Pop Ballad": 1, "Pop Rap": 0, "Pop Rock": 2, "R&B": 1, Rap: 0, Rock: 0 },
  { year: "2001", "Country Pop": 0,  "Hip Hop": 2, "Latin Pop": 0, Pop: 3, "Pop Ballad": 0, "Pop Rap": 0, "Pop Rock": 3, "R&B": 1, Rap: 0, Rock: 1 },
  { year: "2002", "Country Pop": 0,  "Hip Hop": 2, "Latin Pop": 0, Pop: 1, "Pop Ballad": 0, "Pop Rap": 0, "Pop Rock": 1, "R&B": 3, Rap: 0, Rock: 3 },
  { year: "2003", "Country Pop": 0,  "Hip Hop": 1, "Latin Pop": 0, Pop: 3, "Pop Ballad": 0, "Pop Rap": 0, "Pop Rock": 2, "R&B": 1, Rap: 1, Rock: 2 },
  { year: "2004", "Country Pop": 0,  "Hip Hop": 3, "Latin Pop": 0, Pop: 3, "Pop Ballad": 0, "Pop Rap": 0, "Pop Rock": 1, "R&B": 3, Rap: 0, Rock: 0 },
  { year: "2005", "Country Pop": 0,  "Hip Hop": 1, "Latin Pop": 0, Pop: 2, "Pop Ballad": 1, "Pop Rap": 0, "Pop Rock": 2, "R&B": 2, Rap: 1, Rock: 1 },
  { year: "2006", "Country Pop": 0,  "Hip Hop": 4, "Latin Pop": 1, Pop: 3, "Pop Ballad": 1, "Pop Rap": 0, "Pop Rock": 0, "R&B": 1, Rap: 0, Rock: 0 },
  { year: "2007", "Country Pop": 1,  "Hip Hop": 3, "Latin Pop": 0, Pop: 6, "Pop Ballad": 0, "Pop Rap": 0, "Pop Rock": 0, "R&B": 0, Rap: 0, Rock: 0 },
  { year: "2008", "Country Pop": 0,  "Hip Hop": 2, "Latin Pop": 0, Pop: 0, "Pop Ballad": 3, "Pop Rap": 0, "Pop Rock": 1, "R&B": 4, Rap: 0, Rock: 0 },
  { year: "2009", "Country Pop": 1,  "Hip Hop": 2, "Latin Pop": 0, Pop: 5, "Pop Ballad": 0, "Pop Rap": 0, "Pop Rock": 1, "R&B": 0, Rap: 1, Rock: 0 },
  { year: "2010", "Country Pop": 1,  "Hip Hop": 0, "Latin Pop": 0, Pop: 7, "Pop Ballad": 0, "Pop Rap": 2, "Pop Rock": 0, "R&B": 0, Rap: 0, Rock: 0 },
  { year: "2011", "Country Pop": 0,  "Hip Hop": 0, "Latin Pop": 0, Pop: 7, "Pop Ballad": 1, "Pop Rap": 1, "Pop Rock": 0, "R&B": 1, Rap: 0, Rock: 0 },
  { year: "2012", "Country Pop": 0,  "Hip Hop": 0, "Latin Pop": 0, Pop: 9, "Pop Ballad": 0, "Pop Rap": 1, "Pop Rock": 0, "R&B": 0, Rap: 0, Rock: 0 },
  { year: "2013", "Country Pop": 0,  "Hip Hop": 1, "Latin Pop": 0, Pop: 3, "Pop Ballad": 2, "Pop Rap": 3, "Pop Rock": 1, "R&B": 0, Rap: 0, Rock: 0 },
  { year: "2014", "Country Pop": 0,  "Hip Hop": 1, "Latin Pop": 0, Pop: 4, "Pop Ballad": 2, "Pop Rap": 2, "Pop Rock": 1, "R&B": 0, Rap: 0, Rock: 0 },
  { year: "2015", "Country Pop": 0,  "Hip Hop": 3, "Latin Pop": 0, Pop: 3, "Pop Ballad": 2, "Pop Rap": 0, "Pop Rock": 1, "R&B": 1, Rap: 0, Rock: 0 },
  { year: "2016", "Country Pop": 0,  "Hip Hop": 1, "Latin Pop": 0, Pop: 7, "Pop Ballad": 1, "Pop Rap": 0, "Pop Rock": 1, "R&B": 0, Rap: 0, Rock: 0 },
  { year: "2017", "Country Pop": 1,  "Hip Hop": 1, "Latin Pop": 1, Pop: 3, "Pop Ballad": 0, "Pop Rap": 1, "Pop Rock": 1, "R&B": 0, Rap: 2, Rock: 0 },
  { year: "2018", "Country Pop": 0,  "Hip Hop": 0, "Latin Pop": 1, Pop: 3, "Pop Ballad": 1, "Pop Rap": 4, "Pop Rock": 0, "R&B": 0, Rap: 1, Rock: 0 },
  { year: "2019", "Country Pop": 0,  "Hip Hop": 0, "Latin Pop": 0, Pop: 6, "Pop Ballad": 0, "Pop Rap": 3, "Pop Rock": 0, "R&B": 0, Rap: 1, Rock: 0 },
  { year: "2020", "Country Pop": 1,  "Hip Hop": 0, "Latin Pop": 0, Pop: 5, "Pop Ballad": 1, "Pop Rap": 2, "Pop Rock": 0, "R&B": 0, Rap: 1, Rock: 0 }
];

// ------------------ CHART SETUP ------------------
const svg = d3.select("#mainChart");
const margin = {top:20,right:20,bottom:40,left:55};
const width  = 900 - margin.left - margin.right;
const height = 560 - margin.top - margin.bottom;
const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

const chartTip = d3.select("#tooltip");
function clearChart(){ g.selectAll("*").remove(); }

// Genre keys/colors
const allGenreKeys = ["Rock", "Pop Rock", "Pop", "Pop Ballad", "Country Pop", "Latin Pop", "Pop Rap", "Rap", "Hip Hop", "R&B"];
const color = d3.scaleOrdinal()
  .domain(allGenreKeys)
  .range(["#7ce2ad","#7cc6c6","#7ca8da","#808be9","#a689dd","#c784d0","#e77dc3","#eb9ab3","#ecb79f","#ebd385"]);

// Feature colors (for other views)
const featureColors = { tempo:"#60a5fa", danceability:"#f472b6", energy:"#ef4444", acousticness:"#22c55e", duration_ms:"#a855f7" };

// ------------------ RIGHT‑SIDE UI BUILDERS ------------------
function buildGenreControls(selectedSet){
  const wrap = d3.select("#rightContent");
  wrap.selectAll("*").remove();

  wrap.append("h4").text("Select all that apply");

  // quick actions
  const actions = wrap.append("div").attr("class","ctl-row");
  actions.append("button").attr("class","pill").text("All").on("click",()=>{ selectedSet.clear(); allGenreKeys.forEach(k=>selectedSet.add(k)); renderGenre([...selectedSet]); buildGenreControls(selectedSet); });
  actions.append("button").attr("class","pill").text("None").on("click",()=>{ selectedSet.clear(); renderGenre([...selectedSet]); buildGenreControls(selectedSet); });
  actions.append("span").attr("class","tiny").text("Tip: toggle individual genres below");

  // grid of checkboxes
  const grid = wrap.append("div").attr("class","genre-grid");
  const row = grid.selectAll("label.genre-item").data(allGenreKeys, d=>d).join("label").attr("class","genre-item");

  row.append("input")
    .attr("type","checkbox")
    .property("checked", d=> selectedSet.has(d))
    .on("change", function(evt, d){
      if (this.checked) selectedSet.add(d); else selectedSet.delete(d);
      renderGenre([...selectedSet]);
    });

  row.append("span").attr("class","swatch").style("background", d=> color(d));
  row.append("span").text(d=> d);

  if (selectedSet.size === 0) {
    wrap.append("div").attr("class","empty-note").text("No genres selected. Choose at least one to plot.");
  }
}

function buildFeatureSlider(start=1980, end=2020, onChange){
  const wrap = d3.select("#rightContent");
  wrap.selectAll("*").remove();

  wrap.append("div").attr("class","tiny").text("Year Range");
  const slider = wrap.append("div").style("width","90%")
    .style("height","28px").style("position","relative");
  slider.append("div").style("position","absolute").style("left","0").style("right","0").style("top","50%")
    .style("height","6px").style("transform","translateY(-50%)").style("background","#2b3c6f").style("border-radius","3px");
  const rangeEl = slider.append("div").style("position","absolute").style("height","6px").style("background","#6ea8fe").style("border-radius","3px");
  const hMin = slider.append("div").style("position","absolute").style("width","16px").style("height","16px").style("background","#6ea8fe").style("border","1px solid rgba(255,255,255,.35)").style("border-radius","50%")
    .style("top","50%").style("transform","translate(-50%,-50%)").style("cursor","pointer");
  const hMax = slider.append("div").style("position","absolute").style("width","16px").style("height","16px").style("background","#6ea8fe").style("border","1px solid rgba(255,255,255,.35)").style("border-radius","50%")
    .style("top","50%").style("transform","translate(-50%,-50%)").style("cursor","pointer");
  const tMin = slider.append("div").attr("class","tiny").style("position","absolute");
  const tMax = slider.append("div").attr("class","tiny").style("position","absolute");
  const label = wrap.append("div").attr("class","tiny");

  const minYear = d3.min(audioData, d=>d.year), maxYear = d3.max(audioData, d=>d.year);
  let yearStart=start, yearEnd=end; const minGap=5;
  const node = slider.node();
  const sliderW = () => node.getBoundingClientRect().width;
  const yearToX = y => ((y-minYear)/(maxYear-minYear))*sliderW();
  const xToYear = x => Math.round(minYear + (x/sliderW())*(maxYear-minYear));
  function update(){
    const xMin = yearToX(yearStart), xMax = yearToX(yearEnd);
    hMin.style("left", xMin+"px"); hMax.style("left", xMax+"px");
    rangeEl.style("left", xMin+"px").style("width", (xMax-xMin)+"px");
    tMin.style("left", xMin+"px").style("transform","translate(-50%,-170%)").text(yearStart);
    tMax.style("left", xMax+"px").style("transform","translate(-50%,-170%)").text(yearEnd);
    label.text(`${yearStart} – ${yearEnd}`);
    onChange(yearStart, yearEnd);
  }
  const dragMin = d3.drag().on("drag", (e)=>{ let x=e.x; x=Math.min(x, yearToX(yearEnd-minGap)); x=Math.max(0,x); yearStart=xToYear(x); update(); });
  const dragMax = d3.drag().on("drag", (e)=>{ let x=e.x; x=Math.max(x, yearToX(yearStart+minGap)); x=Math.min(sliderW(),x); yearEnd=xToYear(x); update(); });
  d3.select(hMin.node()).call(dragMin); d3.select(hMax.node()).call(dragMax);
  update();
  window.addEventListener('resize', update, {passive:true});
}

// ------------------ RENDERERS ------------------
function renderGenre(selectedKeys){
  clearChart();
  const keys = selectedKeys.length ? selectedKeys : [];

  // Axes setup
  const x = d3.scaleBand().domain(genreMini.map(d=>d.year)).range([0,width]).padding(0.2);
  let yMax = 10; // default max stack height for Top 10 chart
  if (keys.length){
    // build stacked data only for selected keys
    const stacked = d3.stack().keys(keys)(genreMini);
    yMax = d3.max(stacked[stacked.length-1], d=> d[1]);

    // draw layers
    const y = d3.scaleLinear().domain([0, yMax]).nice().range([height,0]);
    g.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x).tickValues(x.domain().filter((d,i)=>!(i%5))));
    g.append("g").call(d3.axisLeft(y));

    const groups = g.selectAll("g.layer").data(stacked, s=>s.key).join(
      enter => enter.append("g").attr("class","layer").attr("fill", s => color(s.key)),
      update => update.attr("fill", s => color(s.key)),
      exit => exit.remove()
    );

    groups.selectAll("rect")
      .data(d => d, d => d.data.year)
      .join(
        enter => enter.append("rect")
          .attr("x", d=> x(d.data.year))
          .attr("y", d=> y(d[1]))
          .attr("height", d=> y(d[0]) - y(d[1]))
          .attr("width", x.bandwidth())
          .on("mousemove", (event, d) => {
            const genre = d3.select(event.currentTarget.parentNode).datum().key;
            const count = d.data[genre];
            chartTip.style("opacity", 1)
              .html(`<strong>Year:</strong> ${d.data.year}<br/><strong>Genre:</strong> ${genre}<br/><strong>Count:</strong> ${count}`)
              .style("left", (event.pageX + 10) + "px")
              .style("top", (event.pageY - 28) + "px");
          })
          .on("mouseout", () => chartTip.style("opacity", 0)),
        update => update
          .transition().duration(250)
          .attr("x", d=> x(d.data.year))
          .attr("y", d=> y(d[1]))
          .attr("height", d=> y(d[0]) - y(d[1]))
          .attr("width", x.bandwidth()),
        exit => exit.remove()
      );

    // inline legend filtered to selection
    const legend = g.selectAll("g.inlineLegend").data([0]).join("g").attr("class","inlineLegend")
      .attr("transform", `translate(${width+8},0)`);
    const items = legend.selectAll("g.item").data(keys, d=>d).join(
      enter => {
        const it = enter.append("g").attr("class","item");
        it.append("rect").attr("width", 12).attr("height", 12).attr("rx",2).attr("ry",2).attr("fill", d=>color(d));
        it.append("text").attr("x", 16).attr("y", 10).attr("fill","#e8edf7").attr("font-size", 12).text(d=>d);
        return it;
      },
      update => update,
      exit => exit.remove()
    ).attr("transform", (d,i)=> `translate(0, ${i*16})`);
  } else {
    // draw axes with zeroed y (for visual stability)
    const y = d3.scaleLinear().domain([0, yMax]).range([height,0]);
    g.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x).tickValues(x.domain().filter((d,i)=>!(i%5))));
    g.append("g").call(d3.axisLeft(y));
  }
}

function renderFeatureRange(feature="tempo", startYear=1980, endYear=2020){
  clearChart();
  const data = audioData.filter(d=> d.year >= startYear && d.year <= endYear);
  const x = d3.scaleLinear().domain([startYear, endYear]).range([0,width]);
  const yMin = d3.min(data, d=> d[feature]);
  const yMax = d3.max(data, d=> d[feature]);
  let padMin = yMin * 0.95, padMax = yMax * 1.05;
  if (["danceability","energy","acousticness"].includes(feature)){
    padMin = Math.max(0, yMin - 0.05);
    padMax = Math.min(1, yMax + 0.05);
  }
  const y = d3.scaleLinear().domain([padMin, padMax]).range([height, 0]);
  g.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x).tickFormat(d3.format("d")));
  g.append("g").call(d3.axisLeft(y));
  const area = d3.area().x(d=> x(d.year)).y0(height).y1(d=> y(d[feature])).curve(d3.curveMonotoneX);
  g.append("path").datum(data).attr("fill", featureColors[feature] || "#60a5fa").attr("opacity", 0.8).attr("d", area);
  g.selectAll(".dot").data(data).enter().append("circle").attr("class","dot")
    .attr("cx", d=> x(d.year)).attr("cy", d=> y(d[feature])).attr("r", 4).attr("fill", "#000").attr("stroke", "#fff")
    .on("mouseover", function(event,d){
      const v = ["danceability","energy","acousticness"].includes(feature)
                ? d[feature].toFixed(3)
                : (feature==="tempo" ? d[feature].toFixed(3) : Math.round(d[feature]));
      chartTip.style("opacity", 1).html(`Year: ${d.year}<br>${feature}: ${v}`)
        .style("left", (event.pageX + 10) + "px").style("top", (event.pageY - 28) + "px");
    })
    .on("mouseout", () => chartTip.style("opacity", 0));
}

// ------------------ VIEW ROUTER ------------------
const viewButtons = d3.selectAll('.legend button');
let currentView = 'genre';
let selectedGenres = new Set(allGenreKeys); // start with all selected

function setView(view){
  currentView = view;
  viewButtons.classed('active', function(){ return d3.select(this).attr('data-view') === view; });
  if (view === 'genre') {
    buildGenreControls(selectedGenres);
    renderGenre([...selectedGenres]);
  } else {
    buildFeatureSlider(1980, 2020, (a,b)=> renderFeatureRange(view, a, b));
    renderFeatureRange(view, 1980, 2020);
  }
}

viewButtons.on('click', function(){ setView(this.getAttribute('data-view')); });
setView('genre');
</script>
</body>
</html>
